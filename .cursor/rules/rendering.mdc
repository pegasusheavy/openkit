---
description: Rendering system patterns (GPU and CPU)
globs: ["src/render/**/*.rs"]
---

# Rendering System

OpenKit supports both GPU (wgpu) and CPU (tiny-skia) rendering backends.

## Renderer Architecture

```
Renderer (trait)
├── GpuRenderer (wgpu) - Default, GPU-accelerated
└── CpuRenderer (tiny-skia) - Software fallback
```

## Painter API

The `Painter` provides a unified drawing API:

```rust
pub struct Painter {
    commands: Vec<DrawCommand>,
}

impl Painter {
    // Rectangles
    pub fn fill_rect(&mut self, rect: Rect, color: Color);
    pub fn fill_rounded_rect(&mut self, rect: Rect, color: Color, radius: BorderRadius);
    pub fn stroke_rect(&mut self, rect: Rect, color: Color, width: f32);

    // Text
    pub fn draw_text(&mut self, text: &str, pos: Point, color: Color, size: f32);

    // Images
    pub fn draw_image(&mut self, image: &Image, rect: Rect);

    // Finish and get commands
    pub fn finish(self) -> Vec<DrawCommand>;
}
```

## Draw Commands

```rust
pub enum DrawCommand {
    FillRect { rect: Rect, color: Color },
    FillRoundedRect { rect: Rect, color: Color, radius: BorderRadius },
    StrokeRect { rect: Rect, color: Color, width: f32 },
    DrawText { text: String, position: Point, color: Color, size: f32 },
    DrawImage { rect: Rect, image_id: u64 },
    PushClip { rect: Rect },
    PopClip,
}
```

## Implementing Widget Paint

```rust
fn paint(&self, painter: &mut Painter, rect: Rect, ctx: &PaintContext) {
    let theme = ctx.style_ctx.theme;

    // 1. Background
    painter.fill_rounded_rect(
        rect,
        self.background_color(theme),
        BorderRadius::all(theme.radii.md),
    );

    // 2. Border
    if self.variant == ButtonVariant::Outline {
        painter.stroke_rect(rect, theme.colors.border, 1.0);
    }

    // 3. Content
    let text_pos = Point::new(
        rect.x() + (rect.width() - text_width) / 2.0,
        rect.y() + (rect.height() + font_size) / 2.0,
    );
    painter.draw_text(&self.label, text_pos, text_color, font_size);

    // 4. Focus ring
    if self.base.state.focused && ctx.focus_visible {
        let ring_rect = rect.inflate(2.0, 2.0);
        painter.stroke_rect(ring_rect, theme.colors.ring, 2.0);
    }
}
```

## Color Utilities

```rust
impl Color {
    pub fn with_alpha(self, alpha: f32) -> Color;
    pub fn darken(self, percent: f32) -> Color;
    pub fn lighten(self, percent: f32) -> Color;
    pub fn from_hex(hex: &str) -> Result<Color, ColorError>;
}
```

## GPU vs CPU Rendering

The renderer is selected automatically:
- GPU renderer is used by default when available
- CPU renderer is used as fallback

Feature flag in `Cargo.toml`:
```toml
[features]
default = ["gpu"]
gpu = ["wgpu"]
```

Disable GPU for CPU-only:
```bash
cargo build --no-default-features
```

## Performance Tips

1. Minimize draw commands by batching similar operations
2. Use `PushClip`/`PopClip` for clipping instead of complex shapes
3. Cache computed styles when possible
4. Avoid unnecessary repaints - only call `ctx.request_redraw()` when needed
